# 英语教育系统 v4.1 - 排课与考勤管理系统

## 🎯 版本目标

在v4.0完整报名管理系统基础上，增加排课管理和考勤点名功能，形成完整的教学管理闭环，为家长端H5提供完整的课程和学习数据支撑。

## 📊 业务流程设计

### 1. 完整教学管理流程

```
班级创建 → 学员分班 → 排课安排 → 课前准备 → 点名签到 → 上课记录 → 课时消耗 → 家长可见
```

### 2. 核心功能模块

#### 2.1 排课管理
- **一键排课**：日历选择多日期 + 时间段 + 课程 + 教师 + 内容说明
- **课程安排查看**：班级课表、教师课表、教室课表
- **排课冲突检测**：教师时间冲突、教室占用冲突
- **批量操作**：批量排课、批量调课、批量取消

#### 2.2 考勤管理  
- **课前准备**：查看今日课程安排
- **点名签到**：学员出勤状态记录、缺席原因
- **上课记录**：基于点名生成实际上课记录
- **补课安排**：缺席学员补课安排

#### 2.3 数据统计
- **出勤统计**：学员出勤率、班级出勤情况
- **课时统计**：已用课时、剩余课时、课时消耗趋势
- **教学进度**：课程进度、学习内容完成情况

## 🗄️ 数据库表结构设计

### 1. 排课管理相关表

#### 1.1 时间段配置表 (time_slots)
```sql
CREATE TABLE time_slots (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    institution_id BIGINT NOT NULL COMMENT '机构ID',
    name VARCHAR(50) NOT NULL COMMENT '时间段名称',
    start_time TIME NOT NULL COMMENT '开始时间',
    end_time TIME NOT NULL COMMENT '结束时间',
    duration_minutes INT NOT NULL COMMENT '时长(分钟)',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    sort_order INT DEFAULT 0 COMMENT '排序',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (institution_id) REFERENCES institutions(id),
    INDEX idx_institution_timeslots (institution_id, is_active)
);
```

#### 1.2 课程安排表 (class_schedules)
```sql
CREATE TABLE class_schedules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    class_id BIGINT NOT NULL COMMENT '班级ID',
    course_id BIGINT NOT NULL COMMENT '课程ID',
    teacher_id BIGINT NOT NULL COMMENT '授课教师ID',
    time_slot_id BIGINT NOT NULL COMMENT '时间段ID',
    schedule_date DATE NOT NULL COMMENT '上课日期',
    lesson_content VARCHAR(100) NULL COMMENT '上课内容说明(最多20字)',
    classroom VARCHAR(50) NULL COMMENT '教室',
    status ENUM('scheduled', 'completed', 'cancelled', 'rescheduled') DEFAULT 'scheduled' COMMENT '状态',
    created_by BIGINT NOT NULL COMMENT '创建人ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (class_id) REFERENCES classes(id),
    FOREIGN KEY (course_id) REFERENCES courses(id),
    FOREIGN KEY (teacher_id) REFERENCES users(id),
    FOREIGN KEY (time_slot_id) REFERENCES time_slots(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    
    INDEX idx_class_schedule (class_id, schedule_date),
    INDEX idx_teacher_schedule (teacher_id, schedule_date),
    INDEX idx_date_schedule (schedule_date, status),
    UNIQUE KEY uk_class_datetime (class_id, schedule_date, time_slot_id)
);
```

### 2. 考勤管理相关表

#### 2.1 考勤记录表 (attendance_records)
```sql
CREATE TABLE attendance_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    schedule_id BIGINT NOT NULL COMMENT '课程安排ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    attendance_status ENUM('present', 'absent', 'late', 'leave_early', 'sick_leave', 'personal_leave') DEFAULT 'present' COMMENT '出勤状态',
    check_in_time TIMESTAMP NULL COMMENT '签到时间',
    absence_reason VARCHAR(200) NULL COMMENT '缺席原因',
    makeup_required BOOLEAN DEFAULT FALSE COMMENT '是否需要补课',
    makeup_scheduled BOOLEAN DEFAULT FALSE COMMENT '是否已安排补课',
    teacher_notes TEXT NULL COMMENT '教师备注',
    recorded_by BIGINT NOT NULL COMMENT '记录人ID',
    recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '记录时间',
    
    FOREIGN KEY (schedule_id) REFERENCES class_schedules(id),
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (recorded_by) REFERENCES users(id),
    
    INDEX idx_schedule_attendance (schedule_id),
    INDEX idx_student_attendance (student_id, recorded_at),
    UNIQUE KEY uk_schedule_student (schedule_id, student_id)
);
```

#### 2.2 实际上课记录表 (actual_lesson_records)
```sql
CREATE TABLE actual_lesson_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    schedule_id BIGINT NOT NULL COMMENT '课程安排ID',
    class_id BIGINT NOT NULL COMMENT '班级ID',
    teacher_id BIGINT NOT NULL COMMENT '教师ID',
    lesson_date DATE NOT NULL COMMENT '上课日期',
    start_time TIME NOT NULL COMMENT '实际开始时间',
    end_time TIME NOT NULL COMMENT '实际结束时间',
    duration_minutes INT NOT NULL COMMENT '实际时长',
    lesson_hours DECIMAL(3,1) NOT NULL COMMENT '消耗课时数',
    actual_content TEXT NULL COMMENT '实际教学内容',
    homework_assigned TEXT NULL COMMENT '布置的作业',
    class_notes TEXT NULL COMMENT '课堂笔记',
    present_count INT NOT NULL COMMENT '出勤人数',
    absent_count INT NOT NULL COMMENT '缺席人数',
    total_students INT NOT NULL COMMENT '班级总人数',
    attendance_rate DECIMAL(5,2) GENERATED ALWAYS AS (present_count / total_students * 100) COMMENT '出勤率',
    status ENUM('completed', 'cancelled') DEFAULT 'completed' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (schedule_id) REFERENCES class_schedules(id),
    FOREIGN KEY (class_id) REFERENCES classes(id),
    FOREIGN KEY (teacher_id) REFERENCES users(id),
    
    INDEX idx_class_lessons (class_id, lesson_date),
    INDEX idx_teacher_lessons (teacher_id, lesson_date),
    INDEX idx_schedule_lesson (schedule_id)
);
```

### 3. 补课管理相关表

#### 3.1 补课安排表 (makeup_schedules)
```sql
CREATE TABLE makeup_schedules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    original_schedule_id BIGINT NOT NULL COMMENT '原课程安排ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    teacher_id BIGINT NOT NULL COMMENT '补课教师ID',
    makeup_date DATE NOT NULL COMMENT '补课日期',
    time_slot_id BIGINT NOT NULL COMMENT '补课时间段',
    makeup_type ENUM('individual', 'group') DEFAULT 'individual' COMMENT '补课类型',
    status ENUM('scheduled', 'completed', 'cancelled') DEFAULT 'scheduled' COMMENT '状态',
    reason TEXT NULL COMMENT '补课原因',
    notes TEXT NULL COMMENT '备注',
    created_by BIGINT NOT NULL COMMENT '创建人ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (original_schedule_id) REFERENCES class_schedules(id),
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (teacher_id) REFERENCES users(id),
    FOREIGN KEY (time_slot_id) REFERENCES time_slots(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    
    INDEX idx_student_makeup (student_id, makeup_date),
    INDEX idx_teacher_makeup (teacher_id, makeup_date)
);
```

## 🎨 功能界面设计

### 1. 排课管理界面

#### 1.1 一键排课弹窗
- **选择班级**：下拉选择已有班级
- **日历选择**：支持多选日期的日历组件
- **时间段选择**：下拉选择 + 设置按钮(未来扩展)
- **授课课程**：显示班级关联的课程(如：原典法英语)
- **授课教师**：下拉选择可用教师
- **上课内容**：文本输入框(最多20字)
- **教室选择**：可选，文本输入
- **批量生成**：确认后批量创建排课记录

#### 1.2 课程表视图
- **班级课表**：以班级为维度的周/月视图
- **教师课表**：以教师为维度的周/月视图  
- **日程总览**：机构整体课程安排
- **筛选功能**：按班级、教师、日期范围筛选

### 2. 考勤管理界面

#### 2.1 今日课程
- **课程列表**：显示当日所有课程安排
- **班级信息**：班级名称、上课时间、教师
- **学员统计**：班级总人数、已点名人数
- **操作按钮**：点名、查看详情、取消课程

#### 2.2 点名界面
- **课程信息**：班级、时间、教师、内容
- **学员列表**：班级所有学员
- **出勤状态**：✅出席 / ❌缺席 / 🏥请假 / ⏰迟到 / 🚪早退
- **缺席原因**：文本输入框
- **补课标记**：是否需要安排补课
- **教师备注**：课堂表现、特殊情况
- **提交按钮**：生成上课记录

### 3. 数据统计界面

#### 3.1 出勤统计
- **学员出勤率**：个人出勤统计图表
- **班级出勤情况**：班级整体出勤趋势
- **缺席原因分析**：缺席原因分类统计

#### 3.2 课时统计  
- **课时消耗**：已用/剩余课时统计
- **消耗趋势**：课时使用趋势图
- **预计完课时间**：基于当前进度预测

## 🔄 业务流程详细设计

### 1. 排课流程
```
选择班级 → 选择日期(支持多选) → 选择时间段 → 选择教师 → 填写内容 → 冲突检测 → 批量生成排课
```

### 2. 点名流程
```
查看今日课程 → 选择班级点名 → 逐一标记出勤状态 → 填写缺席原因 → 标记补课需求 → 提交生成记录
```

### 3. 数据流转
```
排课计划(class_schedules) → 点名签到(attendance_records) → 上课记录(actual_lesson_records) → 课时消耗更新
```

## 📱 家长端H5数据支撑

通过以上功能，家长端可以获得：

### 1. 课程信息
- **报名课程**：从student_enrollments获取
- **课程大纲**：从courses → course_levels → course_units → lessons获取
- **学习进度**：从actual_lesson_records计算

### 2. 上课安排
- **课程表**：从class_schedules获取未来课程安排
- **上课时间**：具体的日期和时间段
- **授课教师**：教师信息
- **上课内容**：每节课的学习重点

### 3. 学习记录
- **出勤记录**：从attendance_records获取
- **课时消耗**：已用/剩余课时统计
- **学习内容**：每节课实际学习的内容
- **作业布置**：课后作业和复习内容

### 4. 学习分析
- **出勤率统计**：个人出勤情况分析
- **学习进度**：课程完成百分比
- **预计完课时间**：基于当前进度预测

## 🎯 v4.1 开发计划

### 阶段1：数据库建设 (3-5天)
- [ ] 创建时间段配置表和基础数据
- [ ] 创建课程安排表
- [ ] 创建考勤记录表
- [ ] 创建实际上课记录表
- [ ] 创建补课安排表

### 阶段2：排课功能开发 (5-7天)
- [ ] 时间段管理API
- [ ] 一键排课API (支持批量)
- [ ] 课程表查询API
- [ ] 排课冲突检测逻辑
- [ ] 排课前端界面

### 阶段3：考勤功能开发 (5-7天)  
- [ ] 今日课程查询API
- [ ] 点名签到API
- [ ] 上课记录生成API
- [ ] 考勤统计API
- [ ] 点名前端界面

### 阶段4：数据统计功能 (3-5天)
- [ ] 出勤率统计API
- [ ] 课时消耗统计API
- [ ] 学习进度计算API
- [ ] 统计报表界面

### 阶段5：家长端数据接口 (2-3天)
- [ ] 家长端课程信息API
- [ ] 家长端学习记录API
- [ ] 家长端统计数据API

## 📋 临时数据准备

在开发期间，需要准备以下基础数据：

### 1. 时间段配置
```sql
INSERT INTO time_slots (institution_id, name, start_time, end_time, duration_minutes) VALUES
(1, '上午第一节', '09:00:00', '10:30:00', 90),
(1, '上午第二节', '10:45:00', '12:15:00', 90),
(1, '下午第一节', '14:00:00', '15:30:00', 90),
(1, '下午第二节', '15:45:00', '17:15:00', 90),
(1, '晚上第一节', '18:30:00', '20:00:00', 90),
(1, '晚上第二节', '20:15:00', '21:45:00', 90);
```

### 2. 测试排课数据
为现有班级创建一周的排课安排，用于测试点名和上课记录功能。

这样的设计既满足了当前的实际需求，又为未来的家长端H5提供了完整的数据支撑。
