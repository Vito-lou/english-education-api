# 英语教育系统 v4.0 - 完整报名管理系统

## 🎯 版本目标

构建完整的教培机构报名管理系统，支持从潜在学员到正式学员的全流程管理，包括报名、缴费、分班、上课记录等完整业务链条。

## 📊 业务流程设计

### 1. 学员生命周期管理

```
潜在学员 → 试听学员 → 报名学员 → 正式学员 → 毕业学员
    ↓         ↓         ↓         ↓         ↓
  跟进      试听安排    报名缴费    分班上课    结业证书
```

### 2. 核心业务流程

#### 2.1 学员获取与跟进
- **潜在学员录入**：基本信息、来源渠道、意向等级
- **跟进管理**：跟进记录、状态更新、转化追踪
- **试听安排**：试听课程预约、试听反馈记录

#### 2.2 学员报名流程
- **报名申请**：选择校区、课程、级别
- **费用计算**：课程费用、教材费、优惠政策
- **缴费管理**：支付方式、分期付款、发票开具
- **订单生成**：报名订单、费用明细、合同签署

#### 2.3 教学管理流程
- **分班管理**：根据级别和时间安排分班
- **排课管理**：课程表生成、教师安排、教室分配
- **上课记录**：考勤管理、课时消耗、学习进度
- **作业管理**：作业布置、提交、批改反馈

#### 2.4 财务管理流程
- **收费管理**：学费收取、退费处理、欠费提醒
- **成本管理**：教师课时费、教材成本、运营费用
- **财务报表**：收入统计、利润分析、现金流管理

## 🗄️ 数据库表结构设计

### 1. 学员报名相关表

#### 1.1 学员报名表 (student_enrollments)
```sql
CREATE TABLE student_enrollments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    student_id BIGINT NOT NULL COMMENT '学员ID',
    institution_id BIGINT NOT NULL COMMENT '机构ID',
    campus_id BIGINT NOT NULL COMMENT '校区ID',
    course_id BIGINT NOT NULL COMMENT '课程ID',
    level_id BIGINT NULL COMMENT '级别ID',
    enrollment_date DATE NOT NULL COMMENT '报名日期',
    start_date DATE NULL COMMENT '开课日期',
    end_date DATE NULL COMMENT '结课日期',
    total_lessons INT NOT NULL COMMENT '总课时数',
    used_lessons INT DEFAULT 0 COMMENT '已用课时数',
    remaining_lessons INT GENERATED ALWAYS AS (total_lessons - used_lessons) COMMENT '剩余课时数',
    status ENUM('pending', 'active', 'suspended', 'completed', 'cancelled') DEFAULT 'pending' COMMENT '报名状态',
    enrollment_fee DECIMAL(10,2) NOT NULL COMMENT '报名费用',
    paid_amount DECIMAL(10,2) DEFAULT 0 COMMENT '已付金额',
    payment_status ENUM('unpaid', 'partial', 'paid', 'refunded') DEFAULT 'unpaid' COMMENT '付款状态',
    sales_person_id BIGINT NULL COMMENT '销售人员ID',
    remarks TEXT NULL COMMENT '备注信息',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (institution_id) REFERENCES institutions(id),
    FOREIGN KEY (campus_id) REFERENCES departments(id),
    FOREIGN KEY (course_id) REFERENCES courses(id),
    FOREIGN KEY (level_id) REFERENCES course_levels(id),
    FOREIGN KEY (sales_person_id) REFERENCES users(id),
    
    INDEX idx_student_enrollment (student_id, status),
    INDEX idx_institution_enrollment (institution_id, status),
    INDEX idx_campus_enrollment (campus_id, enrollment_date),
    INDEX idx_course_enrollment (course_id, level_id)
);
```

#### 1.2 报名订单表 (enrollment_orders)
```sql
CREATE TABLE enrollment_orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_number VARCHAR(32) UNIQUE NOT NULL COMMENT '订单号',
    enrollment_id BIGINT NOT NULL COMMENT '报名ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    institution_id BIGINT NOT NULL COMMENT '机构ID',
    order_date DATE NOT NULL COMMENT '订单日期',
    total_amount DECIMAL(10,2) NOT NULL COMMENT '订单总金额',
    discount_amount DECIMAL(10,2) DEFAULT 0 COMMENT '优惠金额',
    final_amount DECIMAL(10,2) NOT NULL COMMENT '最终金额',
    payment_method ENUM('cash', 'card', 'transfer', 'alipay', 'wechat') NULL COMMENT '支付方式',
    payment_status ENUM('pending', 'paid', 'partial', 'cancelled', 'refunded') DEFAULT 'pending' COMMENT '支付状态',
    contract_signed BOOLEAN DEFAULT FALSE COMMENT '合同是否签署',
    invoice_issued BOOLEAN DEFAULT FALSE COMMENT '发票是否开具',
    created_by BIGINT NOT NULL COMMENT '创建人ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (enrollment_id) REFERENCES student_enrollments(id),
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (institution_id) REFERENCES institutions(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    
    INDEX idx_order_number (order_number),
    INDEX idx_student_order (student_id, order_date),
    INDEX idx_institution_order (institution_id, payment_status)
);
```

#### 1.3 订单明细表 (enrollment_order_items)
```sql
CREATE TABLE enrollment_order_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT '订单ID',
    item_type ENUM('course_fee', 'material_fee', 'registration_fee', 'other') NOT NULL COMMENT '费用类型',
    item_name VARCHAR(255) NOT NULL COMMENT '费用项目名称',
    quantity INT DEFAULT 1 COMMENT '数量',
    unit_price DECIMAL(10,2) NOT NULL COMMENT '单价',
    total_price DECIMAL(10,2) NOT NULL COMMENT '小计',
    description TEXT NULL COMMENT '描述',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES enrollment_orders(id) ON DELETE CASCADE,
    
    INDEX idx_order_items (order_id)
);
```

### 2. 教学管理相关表

#### 2.1 课时记录表 (lesson_records)
```sql
CREATE TABLE lesson_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    enrollment_id BIGINT NOT NULL COMMENT '报名ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    class_id BIGINT NOT NULL COMMENT '班级ID',
    lesson_id BIGINT NULL COMMENT '课时ID',
    teacher_id BIGINT NOT NULL COMMENT '教师ID',
    lesson_date DATE NOT NULL COMMENT '上课日期',
    start_time TIME NOT NULL COMMENT '开始时间',
    end_time TIME NOT NULL COMMENT '结束时间',
    duration_minutes INT NOT NULL COMMENT '课时时长(分钟)',
    lesson_hours DECIMAL(3,1) NOT NULL COMMENT '消耗课时数',
    attendance_status ENUM('present', 'absent', 'late', 'leave_early') DEFAULT 'present' COMMENT '出勤状态',
    lesson_content TEXT NULL COMMENT '课堂内容',
    homework_assigned TEXT NULL COMMENT '布置作业',
    student_performance TEXT NULL COMMENT '学员表现',
    teacher_notes TEXT NULL COMMENT '教师备注',
    status ENUM('scheduled', 'completed', 'cancelled', 'makeup') DEFAULT 'scheduled' COMMENT '课时状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (enrollment_id) REFERENCES student_enrollments(id),
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (class_id) REFERENCES classes(id),
    FOREIGN KEY (lesson_id) REFERENCES lessons(id),
    FOREIGN KEY (teacher_id) REFERENCES users(id),
    
    INDEX idx_student_lessons (student_id, lesson_date),
    INDEX idx_class_lessons (class_id, lesson_date),
    INDEX idx_teacher_lessons (teacher_id, lesson_date),
    INDEX idx_enrollment_lessons (enrollment_id, status)
);
```

#### 2.2 作业管理表 (homework_assignments)
```sql
CREATE TABLE homework_assignments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    lesson_record_id BIGINT NOT NULL COMMENT '课时记录ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    teacher_id BIGINT NOT NULL COMMENT '教师ID',
    title VARCHAR(255) NOT NULL COMMENT '作业标题',
    content TEXT NOT NULL COMMENT '作业内容',
    assigned_date DATE NOT NULL COMMENT '布置日期',
    due_date DATE NOT NULL COMMENT '截止日期',
    submission_status ENUM('not_submitted', 'submitted', 'late_submitted') DEFAULT 'not_submitted' COMMENT '提交状态',
    submitted_at TIMESTAMP NULL COMMENT '提交时间',
    submission_content TEXT NULL COMMENT '提交内容',
    teacher_feedback TEXT NULL COMMENT '教师反馈',
    score DECIMAL(5,2) NULL COMMENT '作业得分',
    max_score DECIMAL(5,2) DEFAULT 100 COMMENT '满分',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (lesson_record_id) REFERENCES lesson_records(id),
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (teacher_id) REFERENCES users(id),
    
    INDEX idx_student_homework (student_id, due_date),
    INDEX idx_teacher_homework (teacher_id, assigned_date)
);
```

### 3. 财务管理相关表

#### 3.1 收费记录表 (payment_records)
```sql
CREATE TABLE payment_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT '订单ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    institution_id BIGINT NOT NULL COMMENT '机构ID',
    payment_number VARCHAR(32) UNIQUE NOT NULL COMMENT '收费单号',
    payment_date DATE NOT NULL COMMENT '收费日期',
    payment_amount DECIMAL(10,2) NOT NULL COMMENT '收费金额',
    payment_method ENUM('cash', 'card', 'transfer', 'alipay', 'wechat') NOT NULL COMMENT '支付方式',
    payment_type ENUM('enrollment', 'makeup', 'material', 'other') DEFAULT 'enrollment' COMMENT '收费类型',
    transaction_id VARCHAR(64) NULL COMMENT '交易流水号',
    receipt_issued BOOLEAN DEFAULT FALSE COMMENT '收据是否开具',
    invoice_issued BOOLEAN DEFAULT FALSE COMMENT '发票是否开具',
    collected_by BIGINT NOT NULL COMMENT '收费人ID',
    remarks TEXT NULL COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES enrollment_orders(id),
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (institution_id) REFERENCES institutions(id),
    FOREIGN KEY (collected_by) REFERENCES users(id),
    
    INDEX idx_payment_number (payment_number),
    INDEX idx_student_payment (student_id, payment_date),
    INDEX idx_institution_payment (institution_id, payment_date)
);
```

#### 3.2 退费记录表 (refund_records)
```sql
CREATE TABLE refund_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    enrollment_id BIGINT NOT NULL COMMENT '报名ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    institution_id BIGINT NOT NULL COMMENT '机构ID',
    refund_number VARCHAR(32) UNIQUE NOT NULL COMMENT '退费单号',
    refund_date DATE NOT NULL COMMENT '退费日期',
    refund_amount DECIMAL(10,2) NOT NULL COMMENT '退费金额',
    refund_reason ENUM('student_request', 'course_cancelled', 'service_issue', 'other') NOT NULL COMMENT '退费原因',
    refund_method ENUM('cash', 'transfer', 'original_method') NOT NULL COMMENT '退费方式',
    remaining_lessons INT NOT NULL COMMENT '剩余课时',
    lesson_unit_price DECIMAL(10,2) NOT NULL COMMENT '课时单价',
    refund_ratio DECIMAL(5,4) DEFAULT 1.0000 COMMENT '退费比例',
    approved_by BIGINT NOT NULL COMMENT '审批人ID',
    processed_by BIGINT NOT NULL COMMENT '处理人ID',
    remarks TEXT NULL COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (enrollment_id) REFERENCES student_enrollments(id),
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (institution_id) REFERENCES institutions(id),
    FOREIGN KEY (approved_by) REFERENCES users(id),
    FOREIGN KEY (processed_by) REFERENCES users(id),
    
    INDEX idx_refund_number (refund_number),
    INDEX idx_student_refund (student_id, refund_date),
    INDEX idx_institution_refund (institution_id, refund_date)
);
```

## 🎯 v4.0 开发计划

### 阶段1：数据库基础建设 (1-2周)
- [ ] 创建报名管理相关数据表
- [ ] 创建教学记录相关数据表  
- [ ] 创建财务管理相关数据表
- [ ] 数据表关系和约束完善
- [ ] 基础数据种子文件

### 阶段2：核心API开发 (2-3周)
- [ ] 学员报名API (报名申请、费用计算、订单生成)
- [ ] 课时记录API (上课记录、考勤管理、课时消耗)
- [ ] 作业管理API (作业布置、提交、批改)
- [ ] 财务管理API (收费记录、退费处理)

### 阶段3：业务逻辑完善 (1-2周)
- [ ] 学员状态自动流转
- [ ] 课时自动消耗计算
- [ ] 财务数据统计分析
- [ ] 报表生成功能

### 阶段4：前端界面开发 (3-4周)
- [ ] 学员报名管理界面
- [ ] 课时记录管理界面
- [ ] 作业管理界面
- [ ] 财务管理界面
- [ ] 数据统计报表界面

## 📋 当前阶段临时方案

在完整系统开发完成前，可通过以下方式手动管理：

### 1. 手动插入报名数据
```sql
-- 学员报名
INSERT INTO student_enrollments (student_id, institution_id, campus_id, course_id, level_id, enrollment_date, total_lessons, enrollment_fee, status) 
VALUES (1, 1, 1, 1, 1, '2025-08-14', 48, 4800.00, 'active');

-- 生成订单
INSERT INTO enrollment_orders (order_number, enrollment_id, student_id, institution_id, order_date, total_amount, final_amount, payment_status, created_by)
VALUES ('ORD20250814001', 1, 1, 1, '2025-08-14', 4800.00, 4800.00, 'paid', 1);
```

### 2. 修改班级学员添加逻辑
- 只允许添加已报名的学员 (student_enrollments.status = 'active')
- 自动关联报名记录和班级

### 3. 课时消耗记录
- 手动插入上课记录
- 自动更新报名表的已用课时数

这样既保证了数据结构的完整性，又能在当前阶段正常使用系统。
